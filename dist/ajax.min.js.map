{"version":3,"sources":["ajax.js"],"names":["global","factory","exports","module","define","amd","Ajax","this","xhrObj","type","opts","postData","i","catch","mobileHandle","xmlHttp","window","XMLHttpRequest","ActiveXObject","MOBLIE_CATCH","push","open","method","url","async","withCredentials","headers","setRequestHeader","send","mergeHeaders","_headers","parseResponse","res","content","JSON","parse","responseText","e","status","data","request_1","_opts","request_2","params","key","join","stringify","parseFileRes","evt","target","XhrFile","form","opt","dom","ot","oloaded","_this","onload","onSuccessItem","onerror","onErrorItem","upload","onprogress","progress","progressBar","lengthComputable","max","total","value","loaded","percent","Math","round","pertime","Date","getTime","perload","speed","bspeed","units","toFixed","resttime","onProgressItem","onBeforeUploadItem","onloadstart","setTimeout","Content-Type","baseUrl","prototype","then","success","error","readyState","cancleUploadFile","abort","clearUploadFile","creatOpts","toUpperCase","ajax","methods_2","indexOf","toLowerCase","methods_1","config","j","uploader","fileObj","files","FormData","append"],"mappings":"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","file":"ajax.min.js","sourcesContent":["(function (global, factory) {\n\ttypeof exports === 'object' && typeof module !== 'undefined' ? module.exports = factory() :\n\ttypeof define === 'function' && define.amd ? define(factory) :\n\t(global.Ajax = factory());\n}(this, (function () { 'use strict';\n\n/*\r\n  xml请求构造函数\r\n*/\nfunction xhrObj(type, opts, postData) {\n\tthis.type = type;\n\tthis.opts = opts;\n\tthis.postData = postData;\n\tthis.catch = opts.catch;\n\tthis.mobileHandle = opts.mobileHandle;\n\tthis.xmlHttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');\n\n\tif (!!this.mobileHandle && typeof this.mobileHandle == 'function') {\n\t\tMOBLIE_CATCH.push(this.xmlHttp);\n\t\tthis.mobileHandle();\n\t}\n\n\tthis.xmlHttp.open(opts.method, opts.url, opts.async);\n\tthis.xmlHttp.withCredentials = opts.withCredentials;\n\tfor (var i in this.opts.headers) {\n\t\tthis.xmlHttp.setRequestHeader(i, this.opts.headers[i]);\n\t}\n\tif (type == \"methods_1\") {\n\t\tthis.xmlHttp.send(null);\n\t} else {\n\n\t\tthis.xmlHttp.send(this.postData);\n\t}\n\treturn this;\n}\n/*\r\n  请求回调\r\n*/\nxhrObj.prototype.then = function (success, error) {\n\tvar _this = this;\n\n\tif (this.xmlHttp.readyState == 4) {\n\t\tthis.catch(parseResponse(this.xmlHttp));\n\t\tif (this.xmlHttp.status >= 200 && this.xmlHttp.status < 300) {\n\t\t\tsuccess(parseResponse(this.xmlHttp));\n\t\t} else {\n\t\t\terror(parseResponse(this.xmlHttp));\n\t\t}\n\t} else {\n\t\tsetTimeout(function () {\n\t\t\t_this.then(success, error);\n\t\t}, 20);\n\t}\n};\n\n// 请求headers合并\nfunction mergeHeaders(headers, _headers) {\n\tfor (var i in _headers) {\n\t\theaders[i] = _headers[i];\n\t}\n\treturn _headers;\n}\n// 构建返回体\nfunction parseResponse(res) {\n\ttry {\n\t\tvar content = JSON.parse(res.responseText);\n\t} catch (e) {\n\t\tvar content = res.responseText;\n\t}\n\tvar data = {\n\t\tstatus: res.status,\n\t\tdata: content\n\t};\n\treturn data;\n}\n\nfunction request_1(_opts) {\n\treturn new xhrObj(\"methods_1\", _opts);\n}\n\nfunction request_2(_opts) {\n\tvar opts = _opts;\n\tvar params = [];\n\tfor (var key in opts.data) {\n\t\tparams.push(key + '=' + opts.data[key]);\n\t}\n\tvar postData = params.join('&');\n\tvar postData = JSON.stringify(opts.data);\n\treturn new xhrObj(\"methods_2\", opts, postData);\n}\n\n// 构建上传返回体\nfunction parseFileRes(evt) {\n\treturn {\n\t\tres: JSON.parse(evt.target.responseText),\n\t\tstatus: evt.target.status\n\t};\n}\n\n/*\r\n  xml上传文件\r\n*/\nfunction XhrFile(form, opt, dom) {\n    var _this = this;\n    this.xmlHttp = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject('Microsoft.XMLHTTP');\n    this.dom = dom;\n    this.xmlHttp.onload = uploadComplete; // 请求完成\n    this.xmlHttp.onerror = uploadFailed; // 请求失败\n\n    this.xmlHttp.upload.onprogress = progressFunction; // 上传进度调用方法实现\n\n\n    this.onSuccessItem = function () {};\n    this.onBeforeUploadItem = function () {};\n    this.onErrorItem = function () {};\n    this.onProgressItem = function () {};\n\n    var ot, oloaded;\n    this.xmlHttp.upload.onloadstart = function () {\n        //上传开始执行方法\n        ot = new Date().getTime(); //设置上传开始时间\n        oloaded = 0; //设置上传开始时，以上传的文件大小为0\n    };\n\n    setTimeout(function () {\n        _this.onBeforeUploadItem(form);\n\n        _this.xmlHttp.open(\"post\", opt.url, true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。\n        _this.xmlHttp.send(form); //开始上传，发送form数据\n    }, 100);\n\n    //上传成功响应\n    function uploadComplete(evt) {\n        //服务断接收完文件返回的结果\n        void 0;\n        var res = parseFileRes(evt).res;\n        var status = parseFileRes(evt).status;\n        _this.onSuccessItem(form, res, status);\n        // dom.value = \"\";\n    }\n    //上传失败\n    function uploadFailed(evt) {\n        var res = parseFileRes(evt).res;\n        var status = parseFileRes(evt).status;\n        _this.onErrorItem(form, res, status);\n    }\n\n    //上传进度实现方法，上传过程中会频繁调用该方法\n    function progressFunction(evt) {\n        var progress = {}; // 包含上传百分百 速度\n        var progressBar = {};\n        if (evt.lengthComputable) {\n            //\n            progressBar.max = evt.total;\n            progressBar.value = evt.loaded;\n            progress.percent = Math.round(evt.loaded / evt.total * 100);\n        }\n\n        var nt = new Date().getTime(); //获取当前时间\n        var pertime = (nt - ot) / 1000; //计算出上次调用该方法时到现在的时间差，单位为s\n        ot = new Date().getTime(); //重新赋值时间，用于下次计算\n        var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b\n        oloaded = evt.loaded; //重新赋值已上传文件大小，用以下次计算\n        //上传速度计算\n        var speed = perload / pertime; //单位b/s\n        var bspeed = speed;\n        var units = 'b/s'; //单位名称\n        if (speed / 1024 > 1) {\n            speed = speed / 1024;\n            units = 'kb/s';\n        }\n        if (speed / 1024 > 1) {\n            speed = speed / 1024;\n            units = 'Mb/s';\n        }\n        speed = speed.toFixed(1);\n        //剩余时间\n        var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);\n        progress.speed = speed + units;\n        progress.resttime = resttime;\n\n        if (bspeed == 0) progress.bspeed = '上传已取消';\n        _this.onProgressItem(form, progress);\n    }\n}\n\n// 取消上传\nXhrFile.prototype.cancleUploadFile = function () {\n    void 0;\n    this.xmlHttp.abort();\n};\n// 清除文件\nXhrFile.prototype.clearUploadFile = function () {\n    this.dom.value = \"\";\n};\n\nwindow.MOBLIE_CATCH = []; //预留mobile拦截数组\n\n/*\r\n    ajax构造函数\r\n*/\nfunction Ajax() {\n\t// 注册初始配置\n\tthis.opts = {};\n\tthis.opts.headers = {\n\t\t'Content-Type': 'application/json;charset=utf-8'\n\t};\n\tthis.opts.method = 'POST';\n\tthis.opts.async = true;\n\tthis.opts.data = null;\n\tthis.opts.url = \"\";\n\tthis.opts.baseUrl = \"\";\n\n\t// 默认跨域不带cookie\n\tthis.withCredentials = false;\n\n\t// 注册拦截函数\n\tthis.catch = function () {};\n\n\t// 移动端请求句柄\n\tthis.mobileHandle = null;\n}\n\n/*\r\n  整合opt\r\n*/\nAjax.prototype.creatOpts = function (opts) {\n\tvar _opts = this.opts;\n\tfor (var i in opts) {\n\t\tif (i == \"headers\") {\n\t\t\t_opts[i] = mergeHeaders(_opts[i], opts[i]);\n\t\t}\n\t\t_opts[i] = opts[i];\n\t}\n\n\t_opts.method = opts.method && opts.method.toUpperCase();\n\n\t_opts.catch = this.catch;\n\t_opts.mobileHandle = this.mobileHandle;\n\treturn _opts;\n};\n\n/*\r\n  ajax方法\r\n*/\nAjax.prototype.ajax = function (_opts) {\n\tvar opts = this.creatOpts(_opts);\n\tif (methods_2.indexOf(opts.method.toLowerCase()) !== -1) {\n\t\tvar xml = request_2(opts);\n\t\treturn xml;\n\t} else if (methods_1.indexOf(opts.method.toLowerCase()) !== -1) {\n\t\tvar xml = request_1(opts);\n\t\treturn xml;\n\t}\n\topts.url = this.opts.baseUrl + opts.url;\n\treturn new xhrObj(opts, xmlHttp);\n};\n\n/*\r\n  暴露一个配置方法\r\n*/\nAjax.prototype.config = function (opts) {\n\tfor (var i in opts) {\n\t\tif (i == \"headers\") {\n\t\t\topts[i] = mergeHeaders(this.opts[i], opts[i]);\n\t\t\tcontinue;\n\t\t}\n\t\tthis.opts[i] = opts[i];\n\t}\n};\n\n// 请求方法集合\nvar methods_1 = ['get', 'delete', 'head', 'options']; //不带data\nvar methods_2 = ['post', 'put', 'patch']; //带data\nfor (var i in methods_1) {\n\t!function (methods_1, i) {\n\t\tAjax.prototype[methods_1[i]] = function (url, _opts) {\n\n\t\t\tvar opts = this.creatOpts(_opts || {});\n\t\t\topts.method = methods_1[i].toUpperCase();\n\t\t\topts.url = this.opts.baseUrl + url;\n\n\t\t\tvar xml = request_1(opts);\n\t\t\treturn xml;\n\t\t};\n\t}(methods_1, i);\n}\nfor (var j in methods_2) {\n\t!function (methods_2, j) {\n\t\tAjax.prototype[methods_2[j]] = function (url, data, opts) {\n\t\t\topts = this.creatOpts(opts || {});\n\t\t\topts.method = methods_2[j].toUpperCase();\n\t\t\topts.url = this.opts.baseUrl + url;\n\t\t\topts.data = data || {};\n\n\t\t\tvar xml = request_2(opts);\n\t\t\treturn xml;\n\t\t};\n\t}(methods_2, j);\n}\n\n/*\r\n  文件上传\r\n*/\nAjax.prototype.uploader = function (dom, opt) {\n\tvar fileObj = dom.files[0]; // js 获取文件对象\n\n\tvar form = new FormData();\n\tform.append(\"file\", fileObj); // 文件对象\n\n\treturn new XhrFile(form, opt, dom);\n};\n\n// 检验是否浏览器环境\ntry {\n    \n} catch (ex) {\n    throw new Error('请在浏览器环境下运行');\n}\n\nvar index = new Ajax();\n\nreturn index;\n\n})));\n"]}